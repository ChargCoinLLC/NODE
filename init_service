ext_path="/ext"
geth_exe="geth-linux-mipsle-1.7.3-4bb3c89d/geth"
geth_mode="fast"
sdcard_swap="/dev/mmcblk0p1"
sdcard_store="/dev/mmcblk0p2"

while [ true ]
do
    if [ ! -d "$ext_path" ]; then
        mkdir $ext_path
    fi        
    
    mounted=$(df | grep $ext_path)
    if [ -z "$mounted" ]; then
        echo "sdcard is not mounted" > /dev/console
        if [ -e "$sdcard_store" ]; then
            swapon $sdcard_swap
            mount $sdcard_store $ext_path
            sleep 5
        fi    
    else
        if [ -f "$ext_path/$geth_exe" ]; then
            break
        else
            echo "loading software ..." > /dev/console
            wget -O /tmp/geth.tar.gz https://gethstore.blob.core.windows.net/builds/geth-linux-mipsle-1.7.3-4bb3c89d.tar.gz
            cd $ext_path
            tar xvzf /tmp/geth.tar.gz
            chmod +x $ext_path/$geth_exe
        fi
    fi
    echo "waiting for sdcard ..." > /dev/console
    sleep 20 
done
echo "starting geth ..." > /dev/console
$ext_path/$geth_exe --datadir=$ext_path/$geth_mode --syncmode=$geth_mode --rpc --rpcaddr "0.0.0.0" --rpcapi "admin,debug,miner,shh,txpool,personal,eth,net,web3" console&
sleep 10
echo "starting switch ..." > /dev/console
switch_service&
echo "done" > /dev/console
exit 0            
    
